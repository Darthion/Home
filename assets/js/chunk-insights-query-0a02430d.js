System.register(["./chunk-vendor.js","./chunk-frameworks.js"],(function(){"use strict";var e,t;return{setters:[function(){},function(i){e=i.b,t=i.bi}],execute:function(){var i='<div class="position-relative text-center color-bg-secondary border rounded-3 px-5 py-9">\n  <svg\n    aria-hidden="true"\n    height="24"\n    viewBox="0 0 24 24"\n    version="1.1"\n    width="24"\n    class="octicon octicon-graph blankslate-icon"\n  >\n    <path d="M2.5 2.75a.75.75 0 00-1.5 0v18.5c0 .414.336.75.75.75H20a.75.75 0 000-1.5H2.5V2.75z"></path>\n    <path\n      d="M22.28 7.78a.75.75 0 00-1.06-1.06l-5.72 5.72-3.72-3.72a.75.75 0 00-1.06 0l-6 6a.75.75 0 101.06 1.06l5.47-5.47 3.72 3.72a.75.75 0 001.06 0l6.25-6.25z"\n    ></path>\n  </svg>\n\n  <h3 class="my-2">Error loading data</h3>\n\n  <p>Unable to render chart.</p>\n</div>';const a={bubbles:!0,cancelable:!0};class n extends HTMLElement{connectedCallback(){this.executeQuery()}get query(){let e=this.getAttribute("query");if(e)return e;const t=this.getAttribute("query-container-id");if(t){const i=document.getElementById(t);i&&(e=i instanceof HTMLInputElement?i.value:i.textContent)}return e}set query(e){e?this.setAttribute("query",e):this.removeAttribute("query")}get apiUrl(){return this.getAttribute("api-url")}set apiUrl(e){e?this.setAttribute("api-url",e):this.removeAttribute("api-url")}get authUrl(){return this.getAttribute("auth-url")}set authUrl(e){e?this.setAttribute("auth-url",e):this.removeAttribute("auth-url")}async executeQuery(){const e=(new Date).getTime(),{query:t,render:i}=this.parseQuery(),a=this.apiUrl;if(!a||!t||!i)return;const o=(new Date).getTime(),{token:c,scope:h,organization:u}=await this.fetchTokenAndScope(),d=(new Date).getTime();if(!c||!h||!u)return;const l=Array.from(this.children).map((e=>e.cloneNode(!0)));this.innerHTML='<div class="position-relative text-center color-bg-secondary border rounded-3 px-5 py-9">\n  <svg\n    aria-hidden="true"\n    height="24"\n    viewBox="0 0 24 24"\n    version="1.1"\n    width="24"\n    class="octicon octicon-graph blankslate-icon"\n  >\n    <path d="M2.5 2.75a.75.75 0 00-1.5 0v18.5c0 .414.336.75.75.75H20a.75.75 0 000-1.5H2.5V2.75z"></path>\n    <path\n      d="M22.28 7.78a.75.75 0 00-1.06-1.06l-5.72 5.72-3.72-3.72a.75.75 0 00-1.06 0l-6 6a.75.75 0 101.06 1.06l5.47-5.47 3.72 3.72a.75.75 0 001.06 0l6.25-6.25z"\n    ></path>\n  </svg>\n\n  <h3 class="my-2">Loading <span class="AnimatedEllipsis"></span></h3>\n</div>',await this.fetchQuery({authQueryTime:d-o,apiUrl:a,children:l,organization:u,query:t,render:i,scope:h,startTime:e,token:c})}async fetchQuery(e){try{const t=(new Date).getTime(),o=await fetch(e.apiUrl,{method:"POST",body:JSON.stringify({query:e.query}),headers:{Authorization:e.token,"X-Auth-Scope":e.scope,"Content-Type":"application/json"}}),c=(new Date).getTime();if(200!==o.status)throw this.innerHTML=i,new Error("Insights API returned status code: "+o.status);const h=await o.json(),{data:u,errors:d}=h;if(!u||!d)throw this.innerHTML=i,new Error("Either no data is returned or data response has changed");if(d&&d.hasErrors)throw this.innerHTML=i,new Error("Insights API Error: "+d.errorMessage);const l=this.formatData(u),g=["series-table","line-chart","stacked-area-chart"];if(0===e.children.length&&!g.includes(e.render))throw this.innerHTML=i,new Error("Query attribute contains unknown render type: "+e.render);const y=encodeURI(JSON.stringify(l));if(e.children.length>0){this.innerHTML="";for(const t of e.children)t.setAttribute("series",y),this.appendChild(t)}else this.innerHTML=`<${e.render} series="${y}"></${e.render}>`;const p=(new Date).getTime();this.dispatchEvent(new CustomEvent("insights-query-datadog-telemetry",Object.assign(Object.assign({},a),{detail:{incrementKey:"execute-success"}}))),this.dispatchEvent(new CustomEvent("insights-query-hydro-telemetry",Object.assign(Object.assign({},a),{detail:{incrementKey:"execute-success",context:{organization:e.organization,"insights.render.time":p-e.startTime,"api.query.time":c-t,"auth.query.time":e.authQueryTime}}})))}catch(r){throw this.dispatchEvent(new CustomEvent("insights-query-datadog-telemetry",Object.assign(Object.assign({},a),{detail:{incrementKey:"execute-error"}}))),this.dispatchEvent(new CustomEvent("insights-query-hydro-telemetry",Object.assign(Object.assign({},a),{detail:{incrementKey:"execute-error",context:{organization:e.organization,"auth.query.time":e.authQueryTime}}}))),this.innerHTML=i,new s(r.message)}}async fetchTokenAndScope(){const e=this.authUrl;if(!e)return{token:null,scope:null,organization:null};try{const t=await fetch(e,{headers:{Accept:"application/json"}}),{token:i,scope:a,organization:o}=await t.json();return{token:i,scope:a,organization:o}}catch(e){throw this.dispatchEvent(new CustomEvent("insights-query-datadog-telemetry",Object.assign(Object.assign({},a),{detail:{incrementKey:"token-fetch-error"}}))),this.dispatchEvent(new CustomEvent("insights-query-hydro-telemetry",Object.assign(Object.assign({},a),{detail:{incrementKey:"token-fetch-error"}}))),new r(e.message)}}formatData(e){return[e.columns.map((e=>e.name)),...e.rows]}parseQuery(){const e=this.query;if(!e)return{query:null,render:null};const t=e.match(/--\s*render\s+(?<render>[^\s]+)/i);return{query:e,render:t&&void 0!==t.groups?t.groups.render:"series-table"}}}class r extends Error{constructor(e){super(e),this.name="InsightsTokenFetchError"}}class s extends Error{constructor(e){super(e),this.name="InsightsDataFetchError"}}window.customElements.get("insights-query")||(window.InsightsQueryElement=n,window.InsightsTokenFetchError=r,window.InsightsDataFetchError=s,window.customElements.define("insights-query",n)),window.addEventListener("insights-query-datadog-telemetry",(t=>{const i={};let a=t.detail.incrementKey;if(a){a="INSIGHTS_QUERY_"+a.replace(/-/g,"_").toUpperCase();const e=a;e&&(i.incrementKey=e)}Object.keys(i).length>0&&e(i)})),window.addEventListener("insights-query-hydro-telemetry",(e=>{const i=e;let a=i.detail.incrementKey;a&&(a="INSIGHTS_QUERY_"+a.replace(/-/g,"_").toUpperCase()),t(a,i.detail.context||{})}))}}}));
//# sourceMappingURL=chunk-insights-query-85e5ecca.js.map
